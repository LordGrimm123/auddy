<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carpe Diem - Stock Simulator</title>
    <style>
        :root {
            --bg: #0b132b;
            --panel: #14213d;
            --card: #1b294a;
            --accent: #4cafef;
            --accent-2: #357abd;
            --text: #ffffff;
            --muted: #eef4ff;
            --muted-2: #d7e3ff;
            --good: #3ddc97;
            --bad: #ff6b6b;
            --border: #ffffff33;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        header {
            background: linear-gradient(90deg, #0e1a34, #18335f);
            padding: 14px 16px;
            text-align: center;
            font-weight: 800;
            letter-spacing: .3px;
            box-shadow: 0 2px 14px #0008;
        }

        .wrap {
            max-width: 1160px;
            margin: 24px auto;
            padding: 0 16px
        }

        .hidden {
            display: none !important
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 6px 24px #0006;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 4px 18px #0005;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid transparent;
            font-weight: 700;
            cursor: pointer;
            transition: .18s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: #041426
        }

        .btn-primary:hover {
            background: var(--accent-2)
        }

        .btn-ghost {
            background: transparent;
            border-color: var(--border);
            color: var(--text)
        }

        .btn-ghost:hover {
            background: #ffffff14
        }

        /* Login */
        .login-shell {
            min-height: 70vh;
            display: grid;
            place-items: center;
        }

        .login-box {
            width: min(480px, 100%);
            padding: 28px
        }

        .input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0e1a34;
            color: #fff;
        }

        .input::placeholder {
            color: #f0f5ff
        }

        label {
            font-size: .9rem;
            color: var(--muted);
            margin-bottom: 6px;
            display: inline-block
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 16px
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr)
        }

        @media (max-width: 960px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        @media (max-width:640px) {
            .grid-3 {
                grid-template-columns: 1fr
            }
        }

        /* Stock tiles */
        .tile {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #0f1c37;
            cursor: pointer;
            transition: transform .12s ease, border-color .12s ease;
        }

        .tile:hover {
            transform: translateY(-1px);
            border-color: #ffffff55
        }

        .tile .name {
            font-weight: 800;
            color: #fff
        }

        .tile .price {
            color: #fff;
            margin-top: 2px;
            font-weight: 800
        }

        /* Metrics row */
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px
        }

        @media (max-width:700px) {
            .metrics {
                grid-template-columns: 1fr
            }
        }

        .metric {
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #0f1c37;
            text-align: center;
        }

        .metric .label {
            font-size: .85rem;
            color: var(--muted-2);
            letter-spacing: .02em
        }

        .metric .value {
            font-size: 1.6rem;
            font-weight: 800;
            margin-top: 6px;
            color: #fff
        }

        /* Details */
        .details {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px
        }

        @media (max-width:900px) {
            .details {
                grid-template-columns: 1fr
            }
        }

        canvas {
            width: 100%;
            height: 220px;
            background: #0b1730;
            border: 1px solid var(--border);
            border-radius: 12px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .spacer {
            flex: 1
        }

        .muted {
            color: var(--muted)
        }

        hr.sep {
            border: none;
            height: 1px;
            background: var(--border);
            margin: 10px 0
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px
        }

        th,
        td {
            text-align: left;
            padding: 8px 10px;
            color: #fff
        }

        th {
            color: #e9f1ff;
            font-weight: 800;
            border-bottom: 1px solid var(--border)
        }

        tr.data {
            background: #0f1c37;
        }

        tr.data td {
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border)
        }

        tr.data td:first-child {
            border-left: 1px solid var(--border);
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        tr.data td:last-child {
            border-right: 1px solid var(--border);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        small.err {
            color: #ffd0d0
        }
    </style>
</head>

<body>
    <header>Carpe Diem - Stock Simulator</header>
    <main class="wrap">
        <section id="loginSection" class="panel login-shell">
            <form id="loginForm" class="login-box card" autocomplete="on" novalidate>
                <h2 style="margin:0 0 14px 0">Sign in</h2>
                <div class="grid">
                    <div>
                        <label for="email">Email</label>
                        <input id="email" type="email" class="input" placeholder="name@gsis.ac.in" required />
                    </div>
                    <div>
                        <label for="password">Password</label>
                        <input id="password" type="password" class="input" placeholder="••••••••" required />
                    </div>
                    <div class="row" style="margin-top:4px">
                        <button id="loginBtn" class="btn btn-primary" type="submit">Log in</button>
                        <span id="loginError" class="muted" style="margin-left:8px"></span>
                    </div>
                </div>
            </form>
        </section>

        <section id="dashboard" class="hidden">
            <div class="panel" style="padding:12px 14px; display: flex; align-items:center; gap:10px; flex-wrap:wrap">
                <strong id="roleHeader">Welcome</strong>
                <span class="spacer"></span>
                <button id="logoutBtn" class="btn btn-ghost">Log out</button>
            </div>

            <div id="traderMetrics" class="metrics hidden" style="margin:16px 0">
                <div class="metric">
                    <div class="label">Working Capital</div>
                    <div class="value">₹<span id="workingCap">0.00</span></div>
                </div>
                <div class="metric">
                    <div class="label">Invested Capital</div>
                    <div class="value">₹<span id="investedCap">0.00</span></div>
                </div>
                <div class="metric">
                    <div class="label">Profit / Loss</div>
                    <div class="value" id="profitLoss">0.00%</div>
                </div>
            </div>

            <div class="panel" style="padding:16px; margin-top:16px;">
                <div class="row" style="margin-bottom: 10px">
                    <h3 style="margin:0">Stocks</h3>
                </div>
                <div id="stockList" class="grid grid-3"></div>
            </div>

            <section class="details" style="margin-top:16px">
                <div class="panel" style="padding:16px">
                    <div class="row">
                        <h3 id="detailName" style="margin:0">Select a stock</h3>
                        <span class="spacer"></span>
                        <div id="detailPrice" class="muted"></div>
                    </div>

                    <canvas id="chart" width="900" height="220"></canvas>

                    <div id="tradeBar" class="row hidden" style="margin-top:10px">
                        <label for="qty" class="muted">Qty</label>
                        <input id="qty" class="input" type="number" min="1" value="1" style="width:120px" />
                        <button id="buyBtn" class="btn btn-primary">Buy</button>
                        <button id="sellBtn" class="btn btn-ghost">Sell</button>
                        <span id="tradeMsg" class="muted"></span>
                    </div>

                    <div id="autoRow" class="row hidden" style="margin-top:10px">
                        <label for="autoPrice" class="muted">Auto-sell at price</label>
                        <input id="autoPrice" class="input" type="number" min="0" placeholder="e.g. 1200" style="width: 160px" />
                        <input id="autoQty" class="input" type="number" min="1" placeholder="qty" style="width:120px" />
                        <button id="setAutoBtn" class="btn btn-primary">Set Auto-Sell</button>
                        <button id="clearAutoBtn" class="btn btn-ghost">Clear</button>
                        <span id="autoMsg" class="muted"></span>
                    </div>

                    <div id="adminPortfolioView" class="hidden">
                        <h3 style="margin:14px 0 8px 0">View Trader Portfolio</h3>
                        <div class="row" style="margin-bottom:8px">
                            <select id="traderSelect" class="input" style="max-width:420px;"></select>
                        </div>
                        <div id="portfolioWrap" class="card" style="padding: 10px; display:none">
                            <h4 id="pfTitle" style="margin:6px 0">Portfolio</h4>
                            <div class="row muted" id="pfSummary"></div>
                            <table style="margin-top:6px">
                                <thead>
                                    <tr>
                                        <th>Stock</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="pfTable"></tbody>
                            </table>
                            <h4 style="margin:12px 0 6px 0">Trade History</h4>
                            <div id="historyWrap" class="card" style="padding:8px; max-height:240px; overflow:auto">
                                <table style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Action</th>
                                            <th>Stock</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="padding: 16px">

                    <div id="traderSide" class="hidden">
                        <h3 style="margin-top:0">My Portfolio</h3>
                        <div class="card" style="padding: 10px; max-height:260px; overflow:auto">
                            <div id="traderPfSummary" class="row muted" style="margin-bottom: 6px"></div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Stock</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="traderPfTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="adminControls" class="hidden">
                        <h3 style="margin-top:0">Admin</h3>
                        <div id="adminOnlyHint" class="muted hidden">Only visible for admins</div>
                        <div class="row" style="align-items:baseline">
                            <label class="muted" style="margin-right: 6px">Selected stock: </label>
                            <strong id="adminSelected" style="font-weight:800">None</strong>
                            <span class="muted" id="adminSelectedPrice" style="margin-left:6px"></span>
                        </div>
                        <div class="row" style="margin-top:8px">
                            <label class="muted">Adjust selected stock</label>
                        </div>
                        <div class="row">
                            <button id="raiseBtn" class="btn btn-primary">Increase 10%</button>
                            <button id="lowerBtn" class="btn btn-ghost">Decrease 10%</button>
                            <button id="raise50Btn" class="btn btn-primary">Increase 50%</button>
                            <button id="lower50Btn" class="btn btn-ghost">Decrease 50%</button>
                        </div>
                        <hr class="sep" />
                        <div class="row">
                            <label class="muted">Set starting funds for ALL traders</label>
                        </div>
                        <div class="row">
                            <input id="allFunds" class="input" type="number" min="0" placeholder="e.g. 100000" style="width:180px" />
                            <button id="applyFundsBtn" class="btn btn-primary">Apply</button>
                            <span id="fundsMsg" class="muted"></span>
                        </div>
                        <hr class="sep" />
                        <div class="row" style="margin-top: 10px">
                             <button id="freezeBtn" class="btn btn-ghost" style="border-color:#ff6b6b;color:#ff6b6b">Freeze Selected</button>
                             <button id="unfreezeBtn" class="btn btn-primary">Unfreeze Selected</button>
                             <span id="freezeMsg" class="muted"></span>
                        </div>
                         <hr class="sep" />
                        <button id="resetBtn" class="btn btn-ghost" style="border-color:#ffc107;color:#ffc107;width:100%">
                            Hard RESET (All Traders + Stocks)
                        </button>
                        <hr class="sep" />
                        <h4 style="margin:6px 0">Trader Rankings</h4>
                        <div id="rankWrap" class="card" style="padding: 10px; max-height:260px; overflow:auto">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Trader</th>
                                        <th>Total Equity</th>
                                        <th>P/L</th>
                                    </tr>
                                </thead>
                                <tbody id="rankTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </section>
    </main>

    <script type="module">
        /***** Firebase *****/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            getDocs,
            onSnapshot,
            query,
            where,
            runTransaction,
            FieldValue
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const APP_ID = "carpe_diem";
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /* Session persistence (non-blocking) */
        (async () => {
            try {
                await setPersistence(auth, browserSessionPersistence);
            } catch (e) {
                console.warn("Auth persistence not set:", e?.message || e);
            }
        })();

        /***** Elements *****/
        const $ = (id) => document.getElementById(id);
        const loginSection = $("loginSection");
        const loginForm = $("loginForm");
        const loginBtn = $("loginBtn");
        const loginError = $("loginError");
        const dashboard = $("dashboard");
        const roleHeader = $("roleHeader");
        const logoutBtn = $("logoutBtn");
        const traderMetrics = $("traderMetrics");
        const workingCapEl = $("workingCap");
        const investedCapEl = $("investedCap");
        const profitLossEl = $("profitLoss");
        const stockList = $("stockList");
        const detailName = $("detailName");
        const detailPrice = $("detailPrice");
        const chartEl = $("chart");
        const qtyEl = $("qty");
        const tradeMsg = $("tradeMsg");
        const tradeBar = $("tradeBar");
        const adminPortfolioView = $("adminPortfolioView");
        const autoPrice = $("autoPrice");
        const autoQty = $("autoQty");
        const setAutoBtn = $("setAutoBtn");
        const clearAutoBtn = $("clearAutoBtn");
        const autoMsg = $("autoMsg");
        const adminOnlyHint = $("adminOnlyHint");
        const adminControls = $("adminControls");
        const raiseBtn = $("raiseBtn");
        const lowerBtn = $("lowerBtn");
        const raise50Btn = $("raise50Btn");
        const lower50Btn = $("lower50Btn");
        const allFunds = $("allFunds");
        const applyFundsBtn = $("applyFundsBtn");
        const fundsMsg = $("fundsMsg");
        const rankTable = $("rankTable");
        const traderSelect = $("traderSelect");
        const portfolioWrap = $("portfolioWrap");
        const pfTitle = $("pfTitle");
        const pfSummary = $("pfSummary");
        const pfTable = $("pfTable");
        const adminSelected = $("adminSelected");
        const adminSelectedPrice = $("adminSelectedPrice");
        const freezeBtn = $("freezeBtn");
        const unfreezeBtn = $("unfreezeBtn");
        const freezeMsg = $("freezeMsg");
        const traderSide = $("traderSide");
        const traderPfSummary = $("traderPfSummary");
        const traderPfTable = $("traderPfTable");
        const buyBtn = $("buyBtn");
        const sellBtn = $("sellBtn");
        const historyTable = $("historyTable");

        /***** State *****/
        let me = null,
            myRole = null;
        let selectedId = null;
        let stocks = {};
        let myTrader = null;
        let series = [];
        let lastSampleTime = 0;
        const TICK_MS = 3000;
        let lastProcessedTick = -1;
        let lastAutosTick = -1;

        const SEED_STOCKS = [
            "Reliance Industries", "TCS", "Infosys", "HDFC Bank", "ICICI Bank",
            "SBI", "Bharti Airtel", "HCL Technologies", "Asian Paints", "Wipro",
            "Tata Motors", "Adani Enterprises", "Hindustan Unilever", "Larsen & Toubro", "Bajaj Finance",
            "Kotak Mahindra Bank", "UltraTech Cement", "NTPC", "JSW Steel", "Tech Mahindra",
            "Power Grid", "Adani Ports", "Axis Bank", "Maruti Suzuki", "Grasim Industries"
        ];

        /***** Pricing helpers (step every 3s) *****/
        function clamp(n) {
            return Math.max(1, Number.isFinite(n) ? n : 0);
        }

        function currentPriceFor(stock) {
            if (!stock) return 0;
            if (Number.isFinite(stock.price)) return stock.price;
            const base = Number.isFinite(stock.baseline) ? stock.baseline : (stock.defaultBaseline || 500);
            return base;
        }

        function jumpOnce(stock) {
            const base = Number.isFinite(stock.baseline) ? stock.baseline : (stock.defaultBaseline || 500);
            if (stock.frozen) {
                stock.price = base;
                return;
            }
            const mag = 0.01 + Math.random() * 0.02; // 1-3%
            const sign = Math.random() < 0.5 ? -1 : 1;
            const next = base * (1 + sign * mag);
            stock.price = Math.round(next * 100) / 100;
        }

        /***** Auth & Roles *****/
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showLogin();
                return;
            }
            me = user;
            let myRoleDoc = await getDoc(doc(db, "artifacts", APP_ID, "public", "data", "roles", user.uid));

            if (myRoleDoc.exists()) {
                myRole = myRoleDoc.data().role;
            } else {
                const rolesCol = collection(db, "artifacts", APP_ID, "public", "data", "roles");
                const qEmail = query(rolesCol, where("email", "==", user.email));
                const snap = await getDocs(qEmail);
                myRole = (!snap.empty) ? (snap.docs[0].data().role) : null;
            }

            if (!myRole) {
                showLogin("Role not found. Create /roles/<UID> with {email, role}.");
                return;
            }

            roleHeader.textContent = `Welcome, ${myRole}`;
            dashboard.classList.remove("hidden");
            loginSection.classList.add("hidden");

            const isAdmin = myRole === "admin";
            traderMetrics.classList.toggle("hidden", isAdmin);
            chartEl.classList.toggle("hidden", isAdmin);
            tradeBar.classList.toggle("hidden", isAdmin);
            $("autoRow").classList.toggle("hidden", isAdmin);
            adminPortfolioView.classList.toggle("hidden", !isAdmin);
            adminControls.classList.toggle("hidden", !isAdmin);
            adminOnlyHint.classList.toggle("hidden", isAdmin);
            traderSide.classList.toggle("hidden", isAdmin);

            if (isAdmin) {
                fillTraderDropdown();
                loadRankingsLoop();
            } else {
                attachTraderDoc();
            }

            listenToStocks();
            startTickTimer();
        });

        function showLogin(err = "") {
            loginSection.classList.remove("hidden");
            dashboard.classList.add("hidden");
            if (err) loginError.innerHTML = `<small class="err">${err}</small>`;
        }

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            loginError.textContent = "";
            loginBtn.disabled = true;
            loginBtn.textContent = "Logging in…";
            const email = $("email").value.trim();
            const pass = $("password").value.trim();
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                loginError.innerHTML = `<small class="err">${err.message}</small>`;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Log in";
            }
        });

        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
            } catch (_) {}
            location.reload();
        });

        /***** Stocks *****/
        function slug(s) {
            return s.toLowerCase().replace(/[^a-z0-9]+/g, "_");
        }

        async function bootstrapStocks() {
            SEED_STOCKS.forEach((name) => {
                const id = slug(name);
                if (!stocks[id]) {
                    stocks[id] = {
                        id,
                        name,
                        defaultBaseline: +(300 + Math.random() * 900).toFixed(2),
                        frozen: false
                    };
                    const ref = doc(db, "artifacts", APP_ID, "public", "data", "stocks", id);
                    setDoc(ref, { name, baseline: stocks[id].defaultBaseline, frozen: false }, { merge: true });
                }
            });
        }

        function listenToStocks() {
            const stocksCol = collection(db, "artifacts", APP_ID, "public", "data", "stocks");
            onSnapshot(stocksCol, (snap) => {
                if (snap.empty) {
                    bootstrapStocks();
                }
                snap.docs.forEach(d => {
                    const data = d.data() || {};
                    const id = d.id;
                    const prev = stocks[id] || {};
                    const base = Number(data.baseline);
                    const baselineChanged = Number.isFinite(prev.baseline) && Number.isFinite(base) && base !== prev.baseline;
                    const priceInit = baselineChanged ?
                        base :
                        (Number.isFinite(prev.price) ? prev.price : (Number.isFinite(base) ? base : prev.defaultBaseline));

                    stocks[id] = {
                        id,
                        name: data.name || prev.name || id,
                        baseline: Number.isFinite(base) ? base : prev.baseline,
                        price: clamp(priceInit),
                        defaultBaseline: prev.defaultBaseline || +(300 + Math.random() * 900).toFixed(2),
                        frozen: !!data.frozen
                    };
                });
                renderStockTiles();
                if (selectedId && stocks[selectedId]) detailName.textContent = stocks[selectedId].name;
                updateTradeControls();
            });
        }

        function renderStockTiles() {
            stockList.innerHTML = ""; // FIX: Clear list before re-rendering
            Object.values(stocks).forEach(s => {
                const p = currentPriceFor(s);
                const el = document.createElement("div");
                el.className = "tile";
                el.innerHTML = `<div class="name">${s.name}</div><div class="price">₹ ${fmt(p)}${s.frozen ? ' (Frozen)' : ''}</div>`;
                el.onclick = () => selectStock(s.id);
                stockList.appendChild(el);
            });
        }

        function updateTradeControls() {
            if (!selectedId) return;
            const s = stocks[selectedId];
            const isFrozen = s?.frozen;
            buyBtn.disabled = sellBtn.disabled = isFrozen || (myRole !== "trader");
            setAutoBtn.disabled = clearAutoBtn.disabled = isFrozen || (myRole !== "trader");
            tradeMsg.textContent = isFrozen ? "This stock is frozen. Trading disabled." : "";
        }

        function selectStock(id) {
            selectedId = id;
            const s = stocks[id];
            detailName.textContent = s.name;
            series = [];
            lastSampleTime = 0;
            tradeMsg.textContent = "";
            adminSelected.textContent = s.name || "None";
            adminSelectedPrice.textContent = `• ₹ ${fmt(currentPriceFor(s))}${s.frozen ? ' • FROZEN' : ''}`;
            raiseBtn.disabled = lowerBtn.disabled = raise50Btn.disabled = lower50Btn.disabled = (myRole !== "admin");
            updateTradeControls();
            drawChart();
        }

        raiseBtn?.addEventListener("click", () => adjustSelected(0.10));
        lowerBtn?.addEventListener("click", () => adjustSelected(-0.10));
        raise50Btn?.addEventListener("click", () => adjustSelected(0.50));
        lower50Btn?.addEventListener("click", () => adjustSelected(-0.50));

        async function adjustSelected(pct) {
            if (!selectedId || myRole !== "admin") return;
            const s = stocks[selectedId];
            const ref = doc(db, "artifacts", APP_ID, "public", "data", "stocks", selectedId);
            const newBase = currentPriceFor(s) * (1 + pct);
            await setDoc(ref, {
                baseline: +newBase.toFixed(2)
            }, {
                merge: true
            });
        }
        
        /***** Trading (transactional + history) *****/
        buyBtn.addEventListener("click", () => trade("buy"));
        sellBtn.addEventListener("click", () => trade("sell"));

        async function trade(kind) {
            tradeMsg.textContent = "";
            if (!me) {
                tradeMsg.textContent = "Please log in.";
                return;
            }
            if (!selectedId) {
                tradeMsg.textContent = "Select a stock first.";
                return;
            }
            const q = Math.max(1, parseInt(qtyEl.value || "1", 10));
            const st = stocks[selectedId];
            if (st?.frozen) {
                tradeMsg.textContent = "This stock is frozen.";
                return;
            }
            const price = currentPriceFor(st);
            const ref = doc(db, "traders", me.uid);

            try {
                await runTransaction(db, async (tx) => {
                    const traderDoc = await tx.get(ref);
                    const data = traderDoc.data() || {};
                    const cash = +data.cash || 0;
                    const portfolio = data.portfolio || {};
                    const pos = portfolio[selectedId] || { quantity: 0 };
                    const newHistoryRecord = {
                        ts: Date.now(),
                        kind: kind,
                        stockId: selectedId,
                        stockName: st?.name || selectedId,
                        qty: q,
                        price: +price,
                        value: +(q * price).toFixed(2)
                    };

                    if (kind === "buy") {
                        const cost = q * price;
                        if (cash < cost) throw new Error("Not enough cash.");
                        const newCash = cash - cost;
                        const newQty = (pos.quantity || 0) + q;
                        const newPortfolio = { ...portfolio, [selectedId]: { quantity: newQty } };
                        tx.update(ref, {
                            cash: +newCash.toFixed(2),
                            portfolio: newPortfolio,
                            history: FieldValue.arrayUnion(newHistoryRecord)
                        });

                    } else { // sell
                        const have = pos.quantity || 0;
                        if (have < q) throw new Error("Not enough shares.");
                        const newQty = have - q;
                        const newCash = cash + q * price;
                        const newPortfolio = { ...portfolio };
                        if (newQty > 0) newPortfolio[selectedId] = { quantity: newQty };
                        else delete newPortfolio[selectedId];
                        tx.update(ref, {
                            cash: +newCash.toFixed(2),
                            portfolio: newPortfolio,
                            history: FieldValue.arrayUnion(newHistoryRecord)
                        });
                    }
                });
                tradeMsg.textContent = `Successfully ${kind === 'buy' ? 'bought' : 'sold'} ${q} shares.`;
            } catch (e) {
                tradeMsg.textContent = e.message;
            }
        }
        
        /***** Charting *****/
        function drawChart() {
            const w = chartEl.width,
                h = chartEl.height;
            const ctx = chartEl.getContext("2d");
            ctx.clearRect(0, 0, w, h);
            if (!series.length) return;

            let min = Math.min(...series),
                max = Math.max(...series);
            if (min === max) {
                min -= 1;
                max += 1;
            }
            const xStep = Math.max(1, Math.floor(w / Math.max(60, series.length)));

            for (let i = 0; i < series.length; i++) {
                const v = series[i];
                const norm = (v - min) / (max - min);
                const barH = Math.max(2, Math.round(norm * (h - 8)));
                const x = i * xStep;
                const up = i > 0 && v >= series[i - 1];
                ctx.fillStyle = up ? "#3ddc97" : "#ff6b6b";
                ctx.fillRect(x, h - barH, xStep - 1, barH);
            }
        }
        
        /***** Ticks & UI loops *****/
        function startTickTimer() {
            const tickLoop = () => {
                const now = Date.now();
                const tick = Math.floor(now / TICK_MS);
                if (tick !== lastProcessedTick) {
                    if (myRole === "admin") {
                        Object.values(stocks).forEach(s => {
                            jumpOnce(s);
                            const ref = doc(db, "artifacts", APP_ID, "public", "data", "stocks", s.id);
                            updateDoc(ref, {
                                price: s.price
                            });
                        });
                    }
                    lastProcessedTick = tick;

                    // Update UI prices
                    document.querySelectorAll(".tile .price").forEach(el => {
                        const s = stocks[el.parentElement.dataset.id];
                        if (s) el.textContent = `₹ ${fmt(currentPriceFor(s))}${s.frozen ? ' (Frozen)' : ''}`;
                    });

                    // Update detail + chart sampling
                    if (selectedId && stocks[selectedId]) {
                        const p = currentPriceFor(stocks[selectedId]);
                        detailPrice.textContent = `₹ ${fmt(p)}${stocks[selectedId].frozen ? ' • FROZEN' : ''}`;
                        if (!chartEl.classList.contains("hidden")) {
                            if (now - lastSampleTime > 200) {
                                lastSampleTime = now;
                                series.push(p);
                                if (series.length > 120) series.shift();
                                drawChart();
                            }
                        }
                    }

                    // Refresh metrics for traders
                    if (myRole === "trader") {
                        updateTraderMetrics();
                    }

                    // Refresh admin summary if a trader is selected
                    if (myRole === "admin" && traderSelect && traderSelect.value && portfolioWrap.style.display !== "none") {
                        const uid = traderSelect.value;
                        getDoc(doc(db, "traders", uid)).then(s => {
                            if (s.exists()) refreshAdminPortfolioSummary(uid, s.data());
                        });
                    }
                }
                requestAnimationFrame(tickLoop);
            };
            tickLoop();
        }

        function fmt(n) {
            return (n || 0).toFixed(2);
        }
    </script>
</body>
</html>
